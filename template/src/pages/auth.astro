---
import Layout from "../components/Layout.astro";
---

<Layout title="账户中心" showNav={false}>
  <!-- 人文复古文革纸张风：米黄旧报纸底 + 轻盈纹理 -->
  <section
    class="retro-paper relative min-h-screen flex items-center justify-center py-20"
  >
    <!-- 极轻纸张颗粒纹理 -->
    <div
      class="paper-grain absolute inset-0 pointer-events-none opacity-8 mix-blend-normal"
    >
    </div>

    <div class="w-full max-w-md px-4">
      <!-- 手写感标题 -->
      <header class="text-center mb-10">
        <h1
          class="text-4xl font-serif text-base-content tracking-wide font-semibold"
        >
          账户中心
        </h1>
        <div class="mt-3 h-px w-16 mx-auto bg-base-content/40"></div>
      </header>

      <!-- 旧报纸卡片：米黄微纹理 + 淡化边框 -->
      <div
        class="paper-card bg-base-100 rounded-lg shadow-md border border-base-300 p-8"
      >
        <!-- 切换标签：极简线框 -->
        <div id="auth-tabs" class="flex justify-center mb-8 gap-2">
          <button
            class="tab-btn tab-active px-4 py-2 text-sm border-b-2 border-primary text-primary font-medium"
            data-tab="login"
          >
            登录
          </button>
          <button
            class="tab-btn px-4 py-2 text-sm border-b-2 border-transparent hover:border-base-content/50"
            data-tab="register"
          >
            注册
          </button>
        </div>

        <!-- 登录表单 -->
        <form id="login-form" class="space-y-6">
          <div class="form-control">
            <input
              id="login-username"
              name="username"
              type="text"
              placeholder="用户名"
              class="input input-bordered w-full placeholder:text-base-content/60"
              required
            />
          </div>
          <div class="form-control">
            <input
              id="login-password"
              name="password"
              type="password"
              placeholder="密码（至少 6 位）"
              class="input input-bordered w-full placeholder:text-base-content/60"
              required
            />
          </div>
          <button type="submit" class="btn btn-primary w-full">登录</button>
          <button
            type="button"
            id="quick-demo"
            class="btn btn-neutral btn-sm w-full mt-2"
            >一键体验（demo / demo123）</button
          >
        </form>

        <!-- 注册表单 -->
        <form id="register-form" class="space-y-6 hidden">
          <div class="form-control">
            <input
              id="reg-username"
              name="username"
              type="text"
              minlength="3"
              placeholder="用户名（至少 3 个字符）"
              class="input input-bordered w-full placeholder:text-base-content/60"
              required
            />
          </div>
          <div class="form-control">
            <input
              id="reg-password"
              name="password"
              type="password"
              minlength="6"
              placeholder="密码（至少 6 位）"
              class="input input-bordered w-full placeholder:text-base-content/60"
              required
            />
          </div>
          <button type="submit" class="btn btn-primary w-full">注册</button>
        </form>

        <div id="auth-message" class="mt-6 text-center text-sm"></div>
      </div>

      <!-- 页脚小字 -->
      <p class="mt-8 text-center text-xs text-base-content/70">
        文革纸张风 · 轻盈复古
      </p>
    </div>
  </section>

  <script>
    import { actions } from "astro:actions";

    const tabs = document.getElementById("auth-tabs");
    const loginForm = document.getElementById(
      "login-form"
    ) as HTMLFormElement | null;
    const registerForm = document.getElementById(
      "register-form"
    ) as HTMLFormElement | null;
    const messageEl = document.getElementById("auth-message");

    function switchTab(tab: "login" | "register") {
      const tabEls = tabs?.querySelectorAll(".tab-btn") ?? [];
      tabEls.forEach((el) => {
        el.classList.remove("tab-active", "border-primary", "text-primary");
        el.classList.add("border-transparent");
      });
      const target = tabs?.querySelector(`[data-tab="${tab}"]`);
      target?.classList.add("tab-active", "border-primary", "text-primary");
      target?.classList.remove("border-transparent");

      if (tab === "login") {
        loginForm?.classList.remove("hidden");
        registerForm?.classList.add("hidden");
      } else {
        registerForm?.classList.remove("hidden");
        loginForm?.classList.add("hidden");
      }
    }

    tabs?.addEventListener("click", (e) => {
      const target = e.target as HTMLElement;
      const tab = target?.getAttribute("data-tab");
      if (tab === "login" || tab === "register") {
        e.preventDefault();
        switchTab(tab);
      }
    });

    loginForm?.addEventListener("submit", async (e) => {
      e.preventDefault();
      messageEl!.textContent = "";
      const form = e.target as HTMLFormElement;
      const fd = new FormData(form);
      const { error, data } = await actions.login(fd);
      if (error) {
        messageEl!.textContent = error.message;
        messageEl!.className = "mt-4 text-center text-sm text-error";
      } else {
        // 登录成功，强制刷新以带上 session cookie
        window.location.href = "/";
      }
    });

    // 一键体验：自动填充并登录
    document.getElementById("quick-demo")?.addEventListener("click", () => {
      (document.getElementById("login-username") as HTMLInputElement).value =
        "demo";
      (document.getElementById("login-password") as HTMLInputElement).value =
        "demo123";
      loginForm?.requestSubmit();
    });

    registerForm?.addEventListener("submit", async (e) => {
      e.preventDefault();
      messageEl!.textContent = "";
      const form = e.target as HTMLFormElement;
      const fd = new FormData(form);
      const { error } = await actions.register(fd);
      if (error) {
        messageEl!.textContent = error.message;
        messageEl!.className = "mt-4 text-center text-sm text-error";
      } else {
        messageEl!.textContent = "注册成功，请使用账号登录";
        messageEl!.className = "mt-4 text-center text-sm text-success";
        // 切换到登录标签
        switchTab("login");
      }
    });
  </script>
</Layout>

<style>
  /* 旧报纸卡片：淡化边框 + 轻盈阴影 */
  .paper-card {
    backdrop-filter: saturate(1.03);
  }
</style>
